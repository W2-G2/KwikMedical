@model IEnumerable<KwikMedical.Models.Ambulance>

<h2>Ambulance Dashboard</h2>

<table class="table">
    <thead>
        <tr>
            <th>Code</th>
            <th>Current City</th>
            <th>Assigned Emergency Call</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var ambulance in Model)
        {
            <tr>
                <td>@ambulance.Code</td>
                <td>@ambulance.CurrentCity</td>
                <td>@ambulance.CurrentEmergencyCallId</td>
                <td>
                    @if (ambulance.CurrentEmergencyCallId.HasValue)
                    {
                        <button onclick="acceptEmergencyCall(@ambulance.Id)">Accept</button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<a asp-action="Create" class="btn btn-success">Add New Ambulance</a>

<!-- Modal for displaying ambulance animation and patient details -->
<div class="modal fade" id="emergencyDetailsModal" tabindex="-1" role="dialog" aria-labelledby="emergencyDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emergencyDetailsModalLabel">Emergency Details</h5>
            </div>
            <div class="modal-body">
                <!-- Animation placeholder -->
                <div id="ambulanceAnimation">
                    <!-- TODO: Insert the ambulance animation here -->
                    <p>Animation of ambulance traveling...</p>
                </div>

                <!-- Patient Details -->
                <div id="patientDetailsSection" style="display: none;">
                    <h6>Patient Details</h6>
                    <p><strong>Name:</strong> <span id="patientFullName"></span></p>
                    <p><strong>Address:</strong> <span id="patientAddress"></span></p>
                    <p><strong>City:</strong> <span id="patientCity"></span></p>
                    <p><strong>Postcode:</strong> <span id="patientPostcode"></span></p>

                    <!-- Medical Record Details -->
                    <div id="medicalRecordDetailsSection">
                        <h3>Medical Record</h3>
                        <label>Clinical Notes:</label>
                        <input type="text" id="medicalRecordClinicalNotes" />
                        <br>

                        <label>Laboratory Reports:</label>
                        <input type="text" id="medicalRecordLaboratoryReports" />
                        <br>

                        <label>Letters:</label>
                        <input type="text" id="medicalRecordLetters" />
                        <br>

                        <label>Prescription Charts:</label>
                        <input type="text" id="medicalRecordPrescriptionCharts" />
                        <br>

                        <label>Telephone Calls:</label>
                        <input type="text" id="medicalRecordTelephoneCalls" />
                        <br>

                        <label>X-rays:</label>
                        <input type="text" id="medicalRecordXrays" />
                        <br>

                        <input type="hidden" id="hiddenEmergencyCallId" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="updateMedicalRecordBtn">Update Medical Record</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function testFunction() {
        console.log("Inline event triggered");
    }

    function acceptEmergencyCall(ambulanceId) {
        fetch('/Ambulances/GetEmergencyDetails?ambulanceId=' + ambulanceId)
            .then(response => response.json())
            .then(data => {
                // Display the animation of the ambulance traveling to the patient
                document.getElementById('ambulanceAnimation').style.display = 'block';
                document.getElementById('patientDetailsSection').style.display = 'none';

                setTimeout(() => {
                    // After the animation, display the patient details and medical record in the modal
                    document.getElementById('ambulanceAnimation').style.display = 'none';
                    document.getElementById('patientDetailsSection').style.display = 'block';

                    // Populate patient details
                    document.getElementById('patientFullName').textContent = data.patientDetails.firstName + ' ' + data.patientDetails.lastName;
                    document.getElementById('patientAddress').textContent = data.patientDetails.address;
                    document.getElementById('patientCity').textContent = data.patientDetails.city;
                    document.getElementById('patientPostcode').textContent = data.patientDetails.postcode;

                    // Populate medical record details
                    document.getElementById('medicalRecordClinicalNotes').value = data.medicalRecord.clinicalNotes;
                    document.getElementById('medicalRecordLaboratoryReports').value = data.medicalRecord.laboratoryReports;
                    document.getElementById('medicalRecordLetters').value = data.medicalRecord.letters;
                    document.getElementById('medicalRecordPrescriptionCharts').value = data.medicalRecord.prescriptionCharts;
                    document.getElementById('medicalRecordTelephoneCalls').value = data.medicalRecord.telephoneCalls;
                    document.getElementById('medicalRecordXrays').value = data.medicalRecord.xrays;

                    // Set the value of the hidden input field to the emergencyCallId
                    document.getElementById('hiddenEmergencyCallId').value = data.emergencyCallId;

                }, 5000);  // 5 seconds for the animation

                // Display the modal
                $('#emergencyDetailsModal').modal('show');
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('updateMedicalRecordBtn').addEventListener('click', function () {
            const emergencyCallId = document.getElementById('hiddenEmergencyCallId').value;
            const updatedMedicalRecord = {
                clinicalNotes: document.getElementById('medicalRecordClinicalNotes').value,
                laboratoryReports: document.getElementById('medicalRecordLaboratoryReports').value,
                letters: document.getElementById('medicalRecordLetters').value,
                prescriptionCharts: document.getElementById('medicalRecordPrescriptionCharts').value,
                telephoneCalls: document.getElementById('medicalRecordTelephoneCalls').value,
                xrays: document.getElementById('medicalRecordXrays').value,
                emergencyCallId: emergencyCallId
            };

            fetch('/Ambulances/UpdateMedicalRecord', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(updatedMedicalRecord)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Medical record updated successfully.');
                        document.getElementById('patientDetailsSection').style.display = 'none';
                        document.getElementById('ambulanceAnimation').textContent = "Animation of ambulance traveling to the hospital...";
                        setTimeout(() => {
                            completeEmergencyCall(emergencyCallId);
                        }, 5000);
                    } else {
                        alert('Error updating the medical record.');
                    }
                });
        });
    });


    function completeEmergencyCall(emergencyCallId) {
        fetch('/Ambulances/CompleteEmergencyCall', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ emergencyCallId: emergencyCallId })
        })
            .then(response => {
                if (response.ok) {
                    // Hide the modal and refresh the page to reflect the changes
                    $('#emergencyDetailsModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error completing the emergency call.');
                }
            });
    }

</script>
