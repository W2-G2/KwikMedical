@model IEnumerable<KwikMedical.Models.Ambulance>

<h2>Ambulance Dashboard</h2>

<table class="table">
    <thead>
        <tr>
            <th>Code</th>
            <th>Current City</th>
            <th>Assigned Emergency Call</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var ambulance in Model)
        {
            <tr>
                <td>@ambulance.Code</td>
                <td>@ambulance.CurrentCity</td>
                <td>@ambulance.CurrentEmergencyCallId</td>
                <td>
                    @if (ambulance.CurrentEmergencyCallId.HasValue)
                    {
                        <button onclick="acceptEmergencyCall(@ambulance.Id)">Accept</button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<a asp-action="Create" class="btn btn-success">Add New Ambulance</a>

<!-- Modal for displaying ambulance animation and patient details -->
<div class="modal fade" id="emergencyDetailsModal" tabindex="-1" role="dialog" aria-labelledby="emergencyDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emergencyDetailsModalLabel">Emergency Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Animation placeholder -->
                <div id="ambulanceAnimation">
                    <!-- TODO: Insert the ambulance animation here -->
                    <p>Animation of ambulance traveling...</p>
                </div>

                <!-- Patient Details -->
                <div id="patientDetailsSection" style="display: none;">
                    <h6>Patient Details</h6>
                    <p><strong>Name:</strong> <span id="patientFullName"></span></p>
                    <p><strong>Address:</strong> <span id="patientAddress"></span></p>
                    <p><strong>City:</strong> <span id="patientCity"></span></p>
                    <p><strong>Postcode:</strong> <span id="patientPostcode"></span></p>

                    <!-- Medical Record Details -->
                    <h6>Medical Record</h6>
                    <!-- TODO: Add fields for the medical record details -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updateMedicalRecordBtn">Update Medical Record</button>
            </div>
        </div>
    </div>
</div>


<script>
    function acceptEmergencyCall(ambulanceId) {
        fetch('/Ambulances/GetEmergencyDetails?ambulanceId=' + ambulanceId)
            .then(response => response.json())
            .then(data => {
                // Display the animation of the ambulance traveling to the patient
                document.getElementById('ambulanceAnimation').style.display = 'block';
                document.getElementById('patientDetailsSection').style.display = 'none';

                setTimeout(() => {
                    // Animation of ambulance traveling to the hospital
                    // TODO: Implement the actual animation logic here

                    setTimeout(() => {
                        // After the animation, complete the emergency call
                        completeEmergencyCall(data.emergencyCallId);
                    }, 10000);  // 10 seconds for the animation to the hospital
                }, 10000);  // 10 seconds for displaying patient details


                setTimeout(() => {
                    // After the animation, display the patient details and medical record in the modal
                    document.getElementById('ambulanceAnimation').style.display = 'none';
                    document.getElementById('patientDetailsSection').style.display = 'block';

                    // Populate patient details
                    document.getElementById('patientFullName').textContent = data.patientDetails.firstName + ' ' + data.patientDetails.lastName;
                    document.getElementById('patientAddress').textContent = data.patientDetails.address;
                    document.getElementById('patientCity').textContent = data.patientDetails.city;
                    document.getElementById('patientPostcode').textContent = data.patientDetails.postcode;

                    // TODO: Populate medical record details

                }, 10000);  // 10 seconds for the animation

                // Display the modal
                $('#emergencyDetailsModal').modal('show');
            });
    }

    // Handle the "Update Medical Record" button click
    document.getElementById('updateMedicalRecordBtn').addEventListener('click', function () {
        // TODO: Implement the logic to update the medical record
    });

    function completeEmergencyCall(emergencyCallId) {
        fetch('/Ambulances/CompleteEmergencyCall', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ emergencyCallId: emergencyCallId })
        })
            .then(response => {
                if (response.ok) {
                    // Hide the modal and refresh the page to reflect the changes
                    $('#emergencyDetailsModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error completing the emergency call.');
                }
            });
    }

</script>
